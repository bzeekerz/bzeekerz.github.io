<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JC Request Form</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    /* --- JCTU Theme Variables --- */
    :root {
      --jctu-primary: #76236C; 
      --jctu-dark: #4a1243;
      --jctu-light: #f3e5f5;
      --jctu-bg-gradient: linear-gradient(135deg, #fdfbfd 0%, #f4ebf4 100%);
    }

    body { 
      background: var(--jctu-bg-gradient); 
      font-family: 'Sarabun', sans-serif; 
      color: #333;
      min-height: 100vh;
    }

    .text-primary { color: var(--jctu-primary) !important; }
    .bg-primary { background-color: var(--jctu-primary) !important; }
    .btn-primary {
      background-color: var(--jctu-primary);
      border-color: var(--jctu-primary);
      box-shadow: 0 4px 6px rgba(118, 35, 108, 0.2);
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      background-color: var(--jctu-dark);
      border-color: var(--jctu-dark);
      transform: translateY(-1px);
      box-shadow: 0 6px 8px rgba(118, 35, 108, 0.3);
    }
    .btn-outline-primary {
      color: var(--jctu-primary);
      border-color: var(--jctu-primary);
    }
    .btn-outline-primary:hover {
      background-color: var(--jctu-primary);
      color: #fff;
    }

    .card { 
      border: none; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
      border-radius: 16px; 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: transform 0.2s;
    }
    
    .logo-img {
      max-height: 80px;
      margin-bottom: 20px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .navbar {
      background: #fff !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-radius: 12px;
    }

    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      padding: 0.6rem 0.8rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--jctu-primary);
      box-shadow: 0 0 0 0.25rem rgba(118, 35, 108, 0.15);
    }

    .hidden { display: none !important; }
    .no-resize { resize: none !important; }
    
    /* --- NEW ENERGY BAR UI --- */
    .energy-bar-container {
      height: 6px;
      background-color: #e9ecef;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }
    .energy-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß -> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á -> ‡πÅ‡∏î‡∏á */
      background-size: 200% 100%;
      background-position: 0% 0%;
      transition: width 0.3s ease, background-position 0.3s ease;
    }
    .pixel-count-text {
      font-size: 0.75rem;
      color: #6c757d;
      text-align: right;
      margin-top: 3px;
      font-weight: 500;
    }
    
    .loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255,255,255,0.85); z-index: 9999; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }
    
    #sig-canvas { 
      background: #fcfcfc; 
      cursor: crosshair; 
      touch-action: none; 
      border: 2px dashed #ddd;
      border-radius: 8px;
    }
    
    .status-wait { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .status-received { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .status-done { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

    .history-item { 
      border-left: 4px solid transparent; 
      transition: bg 0.2s;
    }
    .history-item:hover { background-color: #f8f9fa; }
    
    .admin-panel { border-left: 5px solid var(--jctu-primary); }
    .sortable { cursor: pointer; user-select: none; position: relative; }
    .sortable:hover { background-color: #f1f1f1 !important; color: var(--jctu-primary); }
    .sort-icon { font-size: 0.8rem; margin-left: 5px; color: #ccc; }
    .sort-asc .sort-icon::after { content: "‚ñ≤"; color: var(--jctu-primary); }
    .sort-desc .sort-icon::after { content: "‚ñº"; color: var(--jctu-primary); }

    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div id="loading" class="loading-overlay hidden">
  <img src="https://www.jc.tu.ac.th/images/jctu_logo.png" alt="Loading..." style="width: 60px; margin-bottom: 15px;">
  <div class="spinner-border text-primary" style="width: 2.5rem; height: 2.5rem;" role="status"></div>
  <small class="text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</small>
</div>

<input type="file" id="file-input" class="hidden" accept="application/pdf,image/*">

<div class="container py-4">
  <div id="server-alert" class="alert hidden text-center shadow-sm" role="alert"></div>

  <div id="login-page" class="row justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="col-md-5 col-lg-4">
      <div class="text-center fade-in">
        <img src="https://www.jc.tu.ac.th/images/jctu_logo.png" alt="JC TU Logo" class="logo-img">
        <h4 class="fw-bold mb-4" style="color: var(--jctu-primary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h4>
      </div>
      <div class="card p-4 fade-in">
        <h5 class="text-center mb-4 text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / Login</h5>
        <form id="loginForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="u_name" placeholder="Username" required>
            <label for="u_name">Username</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="u_pass" placeholder="Password" required>
            <label for="u_pass">Password</label>
          </div>
          <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <div class="d-flex justify-content-between mt-4 small">
          <a href="#" class="text-decoration-none text-muted" onclick="showPage('forgot-page')">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
          <a href="#" class="text-decoration-none fw-bold text-primary" onclick="showPage('register-page')">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
        </div>
      </div>
      <div class="text-center mt-4 text-muted small">
        &copy; Faculty of Journalism and Mass Communication
      </div>
    </div>
  </div>

  <div id="register-page" class="hidden row justify-content-center align-items-center" style="min-height: 80vh;">
     <div class="col-md-6 fade-in">
        <div class="text-center mb-3">
          <img src="https://www.jc.tu.ac.th/images/jctu_logo.png" alt="JC TU Logo" style="height: 50px;">
        </div>
        <div class="card p-4">
           <h4 class="text-primary fw-bold mb-3"><i class="bi bi-person-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h4>
           <div class="alert alert-light border small text-muted"><i class="bi bi-info-circle-fill text-primary"></i> ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</div>
           
           <form id="regForm">
              <div class="row g-2">
                <div class="col-6 mb-2">
                   <label class="small text-muted">Username</label>
                   <input type="text" name="reg_username" class="form-control" required>
                </div>
                <div class="col-6 mb-2">
                   <label class="small text-muted">Password</label>
                   <input type="password" name="reg_password" class="form-control" required>
                </div>
              </div>
              
              <div class="mb-2">
                 <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
                 <input type="text" name="reg_name" class="form-control" required>
              </div>
              
              <div class="mb-3">
                <label class="small text-muted d-block">‡πÄ‡∏û‡∏®</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="reg_gender" value="male" required> <label>‡∏ä‡∏≤‡∏¢</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="reg_gender" value="female" required> <label>‡∏´‡∏ç‡∏¥‡∏á</label>
                </div>
              </div>

              <div class="row g-2 mb-2">
                <div class="col-8">
                   <label class="small text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                   <input type="tel" name="reg_std_id" class="form-control" required>
                </div>
                <div class="col-4">
                   <label class="small text-muted">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
                   <input type="tel" name="reg_year" class="form-control" required>
                </div>
              </div>
              
              <div class="mb-2">
                 <label class="small text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                 <input type="tel" name="reg_tel" class="form-control" required>
              </div>
              <div class="mb-4">
                 <label class="small text-muted">Email</label>
                 <input type="email" name="reg_email" class="form-control" required>
              </div>
              
              <button class="btn btn-primary w-100 py-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
              <div class="text-center mt-3">
                 <a href="#" class="text-decoration-none text-muted" onclick="showPage('login-page')"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
              </div>
           </form>
        </div>
     </div>
  </div>

  <div id="forgot-page" class="row justify-content-center align-items-center hidden" style="min-height: 80vh;">
    <div class="col-md-5 col-lg-4 card p-4 fade-in">
      <div class="text-center mb-3">
         <i class="bi bi-key display-4 text-warning"></i>
         <h4 class="mt-2">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
      </div>
      <form id="forgotForm">
        <div class="mb-3">
           <label class="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
           <input type="email" id="forgot_email" class="form-control" placeholder="name@example.com" required>
        </div>
        <button type="submit" class="btn btn-warning w-100 text-white">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <div class="text-center mt-3"><a href="#" class="text-decoration-none" onclick="showPage('login-page')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a></div>
      </form>
    </div>
  </div>

  <div id="reset-page" class="row justify-content-center align-items-center hidden" style="min-height: 80vh;">
    <div class="col-md-5 col-lg-4 card p-4 fade-in">
      <h4 class="text-center mb-3 text-primary">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
      <form id="resetForm">
        <input type="hidden" id="reset_token">
        <div class="mb-3">
           <label class="small text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
           <input type="password" id="new_reset_pass" class="form-control" required>
        </div>
        <div class="mb-4">
           <label class="small text-muted">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
           <input type="password" id="confirm_reset_pass" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
      </form>
    </div>
  </div>

  <div id="app-page" class="hidden fade-in">
    <nav class="navbar navbar-light px-4 mb-4 d-flex justify-content-between align-items-center sticky-top">
      <div class="d-flex align-items-center">
        <img src="https://www.jc.tu.ac.th/images/jctu_logo.png" alt="Logo" style="height: 40px; margin-right: 15px;">
        <div class="lh-1">
           <span class="d-block fw-bold text-primary">JC Request</span>
           <span class="small text-muted">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="disp_name"></span></span>
        </div>
        <span id="disp_gender" class="badge bg-light text-dark border ms-2 small d-none d-md-inline-block"></span>
        <span id="disp_role" class="badge bg-dark ms-1 small"></span>
      </div>
      <div>
        <button class="btn btn-light btn-sm me-1 text-muted border" onclick="showChangePassModal()" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™"><i class="bi bi-gear-fill"></i></button>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </nav>

    <div id="admin-section" class="card p-4 mb-4 admin-panel hidden shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-primary m-0"><i class="bi bi-shield-lock-fill"></i> ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin Console)</h5>
        <span class="badge bg-light text-dark border" id="admin-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="admin-search" class="form-control border-start-0 ps-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username, ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..." onkeyup="filterAdminTable()">
          </div>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-warning btn-sm text-white shadow-sm" onclick="promptBanUser()"><i class="bi bi-person-x"></i> Ban User</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover table-sm small align-middle">
          <thead class="table-light">
            <tr>
              <th class="sortable" onclick="sortAdminTable('timestamp')">Date <span id="sort-timestamp" class="sort-icon"></span></th>
              <th class="sortable" onclick="sortAdminTable('username')">User <span id="sort-username" class="sort-icon"></span></th>
              <th class="sortable" onclick="sortAdminTable('topic')">Topic <span id="sort-topic" class="sort-icon"></span></th>
              <th>File</th>
              <th class="sortable" onclick="sortAdminTable('status')">Status <span id="sort-status" class="sort-icon"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admin-table-body">
            </tbody>
        </table>
      </div>
    </div>

    <div id="change-pass-modal" class="card p-4 mb-4 border border-warning hidden shadow-sm" style="background-color: #fffdf5;">
      <h6 class="text-warning mb-3"><i class="bi bi-key"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h6>
      <form id="changePassForm">
        <div class="row g-2 align-items-end">
          <div class="col-md-4">
             <label class="small text-muted">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°</label>
             <input type="password" name="old_pass" class="form-control form-control-sm" required>
          </div>
          <div class="col-md-4">
             <label class="small text-muted">‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà</label>
             <input type="password" name="new_pass" class="form-control form-control-sm" required>
          </div>
          <div class="col-md-4">
             <button type="submit" class="btn btn-warning btn-sm w-100 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
          </div>
        </div>
      </form>
      <div class="text-end mt-2"><a href="#" class="small text-muted text-decoration-none" onclick="document.getElementById('change-pass-modal').classList.add('hidden')">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</a></div>
    </div>

    <div class="row">
      <div class="col-lg-7 mb-4">
        
        <div class="card p-3 mb-3 border-primary border-opacity-25" style="background-color: #fbf8fc;">
          <label class="fw-bold small mb-2 text-primary"><i class="bi bi-magic"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Template)</label>
          <select id="template_select" class="form-select form-select-sm" onchange="applyTemplate()">
            <option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Template (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) --</option>
          </select>
        </div>

        <div class="card p-4">
          <div class="d-flex align-items-center mb-3 border-bottom pb-2">
             <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">1</div>
             <h5 class="m-0 text-primary fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h5>
          </div>
          
          <form id="mainForm">
            <div class="mb-4">
              <label class="small fw-bold text-muted">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå PDF (Optional)</label>
              <input type="text" name="custom_filename" class="form-control bg-light" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏™‡∏≠‡∏ö_‡∏ô‡∏≤‡∏¢ ‡∏Å. (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ)">
            </div>
            
            <div class="row g-3 mb-3">
               <div class="col-md-12">
                 <label class="small text-muted">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
                 <select name="program" class="form-select">
                   <option value="Thai">‡∏†‡∏≤‡∏Ñ‡∏õ‡∏Å‡∏ï‡∏¥ (Thai)</option>
                   <option value="BJM">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© (BJM)</option>
                 </select>
               </div>
            </div>
            
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                  <label class="small text-muted">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà</label>
                  <input type="tel" name="year" id="main_year" class="form-control" data-limit="1" data-type="number" required>
              </div>
              <div class="col-md-8">
                  <label class="small text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                  <input type="tel" name="tel" id="main_tel" class="form-control" data-limit="10" data-type="number" required>
              </div>
            </div>
            
            <div class="mb-3">
                <label class="small text-muted">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <select name="major" id="major_main_dropdown" class="form-select" required></select>
            </div>
            <div class="mb-3">
                <label class="small text-muted">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label>
                <select name="advisor" id="advisor_dropdown" class="form-select"></select>
            </div>
            <div class="mb-3">
                <label class="small text-muted">Email</label>
                <input type="email" name="email" id="main_email" class="form-control" data-limit="60" data-px="330">
            </div>
            <div class="mb-4">
                <label class="small text-muted">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <textarea name="address" class="form-control no-resize" rows="2" data-limit="95" data-px="540"></textarea>
            </div>
            
            <div class="d-flex align-items-center mb-3 border-bottom pb-2">
             <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">2</div>
             <h5 class="m-0 text-primary fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h5>
            </div>
            
            <div class="mb-3">
              <label class="fw-bold mb-2">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô</label>
              <select name="request_type" class="form-select border-primary" onchange="toggleFields(this.value)" required>
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>
                <option value="t1">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</option>
                <option value="t2">2. ‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</option>
                <option value="t3">3. ‡∏Ç‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥</option>
                <option value="t4">4. ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞</option>
                <option value="t5">5. ‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
                <option value="t6">6. ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                <option value="t7">7. ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                <option value="t8">8. ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á</option>
                <option value="t9">9. ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>
                <option value="t10">10. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
            
            <div id="dynamic-fields" class="bg-light p-4 rounded-3 mb-4 border shadow-sm">
              <p class="text-muted text-center m-0 small" id="empty-msg"><i class="bi bi-arrow-up-circle"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
              
              <div class="d-field hidden" data-topic="t1">
                <label class="small text-muted">‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select name="major_sel" class="form-select major-list"></select>
              </div>
              <div class="d-field hidden" data-topic="t2">
                <label class="small text-muted">‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å</label><select name="major_from" class="form-select major-list mb-2"></select>
                <label class="small text-muted">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏≠‡∏Å</label><select name="major_to" class="form-select major-list"></select>
              </div>
              <div class="d-field hidden" data-topic="t3">
                <label class="small text-muted">‡πÄ‡∏™‡∏ô‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</label><select name="prof_rec" class="form-select teacher-list mb-2"></select>
                <label class="small text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label><input type="tel" name="r_no" class="form-control" data-limit="1" data-type="number">
              </div>
              <div class="d-field hidden" data-topic="t5">
                <div class="row g-2">
                   <div class="col-4"><label class="small text-muted">‡πÄ‡∏ó‡∏≠‡∏°</label><input name="reg_sem" class="form-control" data-limit="1" data-type="number"></div>
                   <div class="col-4"><label class="small text-muted">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label><select name="reg_year" class="form-select year-list"></select></div>
                   <div class="col-12"><label class="small text-muted">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label><input name="reg_reasson" class="form-control" data-limit="30" data-px="240"></div>
                </div>
              </div>
              <div class="d-field hidden" data-topic="t6">
                 <div class="row g-2">
                   <div class="col-6"><label class="small text-muted">‡πÄ‡∏ó‡∏≠‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û</label><input name="re_ad" class="form-control" data-limit="1" data-type="number"></div>
                   <div class="col-6"><label class="small text-muted">‡∏õ‡∏µ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û</label><select name="re_ad_year" class="form-select year-list"></select></div>
                 </div>
              </div>
              <div class="d-field hidden" data-topic="t7 t8">
                 <label class="small text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ</label><input name="location" class="form-control no-resize" data-limit="80" data-px="470">
              </div>
              <div class="d-field hidden" data-topic="t9">
                 <label class="small text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label><input name="items" class="form-control no-resize" data-limit="80" data-px="470">
              </div>
              <div class="d-field hidden" data-topic="t10">
                 <label class="small text-muted">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏</label><input name="other" class="form-control no-resize" data-limit="90" data-px="470">
              </div>
            </div>
            
            <div class="mb-4">
              <label class="fw-bold mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label>
              <textarea name="reason_full" class="form-control no-resize" rows="4" data-limit="280" data-px="1550" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á..."></textarea>
            </div>

            <div class="mb-4 text-center p-3 border rounded bg-white">
              <label class="fw-bold mb-2 d-block">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö)</label>
              <canvas id="sig-canvas" width="300" height="120"></canvas>
              <div class="mt-2">
                 <button type="button" class="btn btn-sm btn-light border" onclick="clearSig()"><i class="bi bi-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
              </div>
              <input type="hidden" name="signature_data" id="signature_data">
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">
               <i class="bi bi-file-earmark-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á (PDF)
            </button>
          </form>
        </div>
      </div>
      
      <div class="col-lg-5">
        <div class="card p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
             <h5 class="m-0 text-primary fw-bold"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h5>
             <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="loadRequests()"><i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
          
          <div id="history-list" class="list-group list-group-flush small" style="max-height: 800px; overflow-y: auto;">
             <div class="text-center text-muted py-5">
                <div class="spinner-border text-light spinner-border-sm text-primary" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
             </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentUser = null;
  let globalTemplates = [];
  let currentUploadFileId = null;
  let adminDataList = [];
  let currentSort = { col: 'timestamp', order: 'desc' };

  const SESSION_KEY = 'JC_FORM_SESSION';
  const SESSION_DURATION = 5 * 60 * 1000; 

  function saveSession(userData) {
    const sessionData = {
      user: userData,
      expiry: new Date().getTime() + SESSION_DURATION
    };
    localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
  }

  function checkSession() {
    const sessionString = localStorage.getItem(SESSION_KEY);
    if (!sessionString) return null;
    const session = JSON.parse(sessionString);
    if (new Date().getTime() > session.expiry) {
      localStorage.removeItem(SESSION_KEY);
      return null;
    }
    return session.user;
  }

  const TOPIC_MAP = {
      't1': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤',
      't2': '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤',
      't3': '‡∏Ç‡∏≠‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥',
      't4': '‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞',
      't5': '‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å',
      't6': '‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
      't7': '‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',
      't8': '‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á',
      't9': '‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
      't10': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
  };
  
  const urlParams = <?!= urlParams ?> || {};
  const serverMsg = "<?= serverMessage ?>";
  const serverStatus = "<?= serverStatus ?>";

  window.onload = function() {
    if (serverMsg && serverMsg !== 'undefined') {
      const alertBox = document.getElementById('server-alert');
      alertBox.className = `alert alert-${serverStatus === 'success' ? 'success' : 'danger'}`;
      alertBox.innerText = serverMsg;
      alertBox.classList.remove('hidden');
    }

    if (urlParams.page === 'reset' && urlParams.token) {
      document.getElementById('reset_token').value = urlParams.token;
      showPage('reset-page');
    } else {
        const savedUser = checkSession();
        if (savedUser) {
            setupAppUI(savedUser); 
        } else {
            showPage('login-page');
        }
    }
    initInputConstraints();
  };

  function setupAppUI(user) {
    currentUser = user;
    document.getElementById('disp_name').innerText = user.name;
    document.getElementById('disp_gender').innerText = user.gender === 'male' ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á';
    
    if(user.role === 'admin') {
       document.getElementById('admin-section').classList.remove('hidden');
       document.getElementById('disp_role').innerText = 'Admin';
    } else {
       document.getElementById('admin-section').classList.add('hidden');
    }

    document.getElementById('main_year').value = user.year || '';
    document.getElementById('main_tel').value = user.tel || '';
    document.getElementById('main_email').value = user.email || '';
    
    showPage('app-page');
    initData();
    loadRequests();
  }

  function showPage(pid) {
    document.querySelectorAll('.container > div[id$="-page"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(pid).classList.remove('hidden');
    if(pid === 'app-page' || pid === 'register-page') setTimeout(initInputConstraints, 100);
  }
  function showChangePassModal() { document.getElementById('change-pass-modal').classList.remove('hidden'); }
  function toggleLoad(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
  
  function logout() { 
      localStorage.removeItem(SESSION_KEY); 
      location.reload(); 
  }

  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault(); toggleLoad(true);
    google.script.run.withSuccessHandler(res => {
      toggleLoad(false);
      if(res.status === 'success') {
        saveSession(res);
        setupAppUI(res);
      } else alert(res.message);
    }).loginUser(document.getElementById('u_name').value, document.getElementById('u_pass').value);
  });

  document.getElementById('regForm').addEventListener('submit', function(e) {
    e.preventDefault(); toggleLoad(true);
    const data = {}; new FormData(this).forEach((v,k)=>data[k]=v);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') showPage('login-page'); }).registerUser(data);
  });

  document.getElementById('forgotForm').addEventListener('submit', e => {
    e.preventDefault(); toggleLoad(true);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') showPage('login-page'); }).requestPasswordReset(document.getElementById('forgot_email').value);
  });

  document.getElementById('resetForm').addEventListener('submit', e => {
    e.preventDefault(); 
    if(document.getElementById('new_reset_pass').value !== document.getElementById('confirm_reset_pass').value) return alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
    toggleLoad(true);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') window.location.href="<?= getScriptUrl() ?>"; }).submitResetPassword(document.getElementById('reset_token').value, document.getElementById('new_reset_pass').value);
  });

  document.getElementById('changePassForm').addEventListener('submit', function(e) {
    e.preventDefault(); toggleLoad(true);
    const data = new FormData(this);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success'){ this.reset(); document.getElementById('change-pass-modal').classList.add('hidden'); } }).changePassword(currentUser.username, data.get('old_pass'), data.get('new_pass'));
  });

  document.getElementById('mainForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if(!currentUser) return;
    saveSig(); toggleLoad(true);
    const data = {}; new FormData(this).forEach((v,k)=>data[k]=v);
    google.script.run.withSuccessHandler(res => {
      toggleLoad(false);
      if(res.status === 'success') {
        if(confirm('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π PDF ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) window.open(res.url);
        loadRequests(); clearSig(); this.reset();
        document.getElementById('main_year').value = currentUser.year || '';
        document.getElementById('main_tel').value = currentUser.tel || '';
        document.getElementById('main_email').value = currentUser.email || '';
        // Reset Bars
        document.querySelectorAll('input, textarea').forEach(el => el.dispatchEvent(new Event('input')));
      } else alert(res.message);
    }).withFailureHandler(e => { toggleLoad(false); alert(e); }).processForm(data, currentUser);
  });

  function loadRequests() {
    if(!currentUser) return;
    document.getElementById('history-list').innerHTML = '<div class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm text-primary"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
    
    google.script.run.withSuccessHandler(data => {
      renderHistory(data);
      if(currentUser.role === 'admin') {
          adminDataList = data;
          renderAdminTable(adminDataList);
      }
    }).getRequestsData(currentUser);
  }

  function renderHistory(list) {
    const el = document.getElementById('history-list');
    if(!list.length) { 
        el.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox display-4 d-block mb-2" style="opacity:0.3"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</div>'; 
        return; 
    }
    
    el.innerHTML = list.map(i => {
      let badge = `<span class="badge status-wait rounded-pill"><i class="bi bi-hourglass-split"></i> ‡∏£‡∏≠</span>`;
      if(i.status === '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß') badge = `<span class="badge status-received rounded-pill"><i class="bi bi-check2"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
      if(i.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') badge = `<span class="badge status-done rounded-pill"><i class="bi bi-check-circle-fill"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>`;

      let adminFileLink = i.adminFile ? `<div class="mt-2"><a href="${i.adminFile}" target="_blank" class="btn btn-success btn-sm w-100 shadow-sm"><i class="bi bi-file-earmark-check"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</a></div>` : '';

      return `
        <div class="list-group-item py-3 px-2 history-item border-bottom">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div style="flex:1;">
               <strong class="d-block text-dark text-truncate" style="max-width:180px;">${i.fileName}</strong>
               <small class="text-muted"><i class="bi bi-calendar"></i> ${i.timestamp}</small>
            </div>
            ${badge}
          </div>
          <div class="small bg-light p-2 rounded">
             <i class="bi bi-tag-fill text-secondary"></i> ${i.type}
          </div>
          <div class="mt-2 d-flex gap-2">
             <a href="${i.pdfUrl}" target="_blank" class="btn btn-sm btn-outline-secondary flex-grow-1"><i class="bi bi-file-pdf"></i> ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a>
             ${i.studentFile ? `<a href="${i.studentFile}" target="_blank" class="btn btn-sm btn-outline-info flex-grow-1"><i class="bi bi-file-earmark-arrow-up"></i> ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>` : ''}
          </div>
          ${adminFileLink}
          <div class="mt-2 pt-2 border-top">
             <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="triggerUpload('${i.fileId}')">
               <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå/‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
             </button>
             <div class="d-flex justify-content-end gap-1">
               <button class="btn btn-sm btn-light border text-warning" onclick="renameItem('${i.fileId}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠"><i class="bi bi-pencil"></i></button>
               <button class="btn btn-sm btn-light border text-danger" onclick="deleteItem('${i.fileId}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"><i class="bi bi-trash"></i></button>
             </div>
          </div>
        </div>`;
    }).join('');
  }

  function renderAdminTable(list) {
    const tbody = document.getElementById('admin-table-body');
    document.getElementById('admin-count').innerText = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    if(list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</td></tr>';
        return;
    }

    tbody.innerHTML = list.map(i => {
        const topicName = TOPIC_MAP[i.type] || i.type || '-';
        let statusClass = 'bg-secondary';
        if(i.status === '‡∏£‡∏≠') statusClass = 'bg-warning text-dark';
        else if(i.status === '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß') statusClass = 'bg-info text-white';
        else if(i.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusClass = 'bg-success text-white';

        return `
      <tr class="align-middle">
        <td class="text-nowrap text-muted small">${i.timestamp}</td>
        <td class="fw-bold text-primary">${i.username}</td>
        <td><span class="badge bg-light text-dark border fw-normal">${topicName}</span></td>
        <td>
            <a href="${i.pdfUrl}" target="_blank" class="btn btn-sm btn-light border">
                <i class="bi bi-file-pdf text-danger"></i> PDF
            </a>
        </td>
        <td>
          <select class="form-select form-select-sm badge ${statusClass} border-0" 
                  style="width:auto; cursor:pointer; padding-right: 2rem;" 
                  onchange="changeStatus('${i.fileId}', this.value); this.className='form-select form-select-sm border-0 badge '+ (this.value==='‡∏£‡∏≠'?'bg-warning text-dark':(this.value==='‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'?'bg-info text-white':'bg-success text-white'))">
            <option value="‡∏£‡∏≠" class="bg-white text-dark" ${i.status==='‡∏£‡∏≠'?'selected':''}>‡∏£‡∏≠</option>
            <option value="‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß" class="bg-white text-dark" ${i.status==='‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" class="bg-white text-dark" ${i.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
        </td>
        <td>
          <div class="btn-group" role="group">
             <button class="btn btn-outline-secondary btn-sm" onclick="triggerUpload('${i.fileId}')" title="Upload Result"><i class="bi bi-upload"></i></button>
             ${i.studentFile ? `<a href="${i.studentFile}" target="_blank" class="btn btn-outline-primary btn-sm" title="View User File"><i class="bi bi-eye"></i></a>` : ''}
          </div>
        </td>
      </tr>
    `;
    }).join('');
    updateSortIcons();
  }

  function sortAdminTable(col) {
    if (currentSort.col === col) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.col = col;
        currentSort.order = 'asc';
    }
    const sortedList = [...adminDataList].sort((a, b) => {
        let valA, valB;
        if (col === 'timestamp') {
            valA = parseCustomDate(a.timestamp);
            valB = parseCustomDate(b.timestamp);
        } else if (col === 'topic') {
            valA = TOPIC_MAP[a.type] || a.type || '';
            valB = TOPIC_MAP[b.type] || b.type || '';
        } else {
            valA = String(a[col] || '').toLowerCase();
            valB = String(b[col] || '').toLowerCase();
        }
        if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
        return 0;
    });
    filterAdminTable(sortedList);
  }

  function filterAdminTable(sourceList = null) {
    let list = sourceList;
    if (!sourceList) { sortAdminTable(currentSort.col); return; }
    const term = document.getElementById('admin-search').value.toLowerCase().trim();
    const filtered = list.filter(item => {
        const topic = (TOPIC_MAP[item.type] || '').toLowerCase();
        const user = (item.username || '').toLowerCase();
        const status = (item.status || '').toLowerCase();
        const date = (item.timestamp || '').toLowerCase();
        return user.includes(term) || topic.includes(term) || status.includes(term) || date.includes(term);
    });
    renderAdminTable(filtered);
  }

  function parseCustomDate(dateStr) {
    if(!dateStr || dateStr === '-') return 0;
    const [dRange, tRange] = dateStr.split(' ');
    if(!dRange) return 0;
    const [d, m, y] = dRange.split('/');
    const [hr, min] = tRange ? tRange.split(':') : [0,0];
    return new Date(y, m-1, d, hr, min).getTime();
  }

  function updateSortIcons() {
    document.querySelectorAll('.sort-icon').forEach(el => el.parentElement.className = 'sortable');
    const activeHeader = document.querySelector(`th[onclick="sortAdminTable('${currentSort.col}')"]`);
    if(activeHeader) { activeHeader.className = `sortable sort-${currentSort.order}`; }
  }

  function triggerUpload(fileId) {
    currentUploadFileId = fileId;
    document.getElementById('file-input').click();
  }
  document.getElementById('file-input').addEventListener('change', function() {
    if (this.files.length === 0) return;
    const file = this.files[0];
    const reader = new FileReader();
    toggleLoad(true);
    reader.onload = function(e) {
      google.script.run.withSuccessHandler(res => {
        toggleLoad(false);
        alert(res.message);
        loadRequests(); 
      }).uploadFile(e.target.result, file.type, currentUploadFileId, currentUser.role, currentUser.username);
    };
    reader.readAsDataURL(file);
  });
  function changeStatus(fileId, newStatus) {
    google.script.run.withSuccessHandler(msg => console.log(msg)).adminUpdateStatus(fileId, newStatus);
  }
  function promptBanUser() {
    const email = prompt("‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:");
    if(email) {
      toggleLoad(true);
      google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res); }).adminBanUser(email);
    }
  }
  function renameItem(fileId) {
     const newName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:");
     if(newName) {
       toggleLoad(true);
       google.script.run.withSuccessHandler(res => {
         toggleLoad(false);
         alert(res.message);
         if(res.status==='success') loadRequests();
       }).renameHistory(fileId, newName, currentUser.username);
     }
  }
  function deleteItem(fileId) {
     if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
       toggleLoad(true);
       google.script.run.withSuccessHandler(res => {
         toggleLoad(false);
         alert(res.message);
         if(res.status==='success') loadRequests();
       }).deleteHistory(fileId, currentUser.username);
     }
  }

  function toggleFields(topic) {
    if (!topic) return;
    document.getElementById('empty-msg').classList.add('hidden');
    document.querySelectorAll('.d-field').forEach(div => {
       const topics = div.getAttribute('data-topic').split(' ');
       if (topics.includes(topic)) div.classList.remove('hidden');
       else div.classList.add('hidden');
    });
  }

  function applyTemplate() {
    const idx = document.getElementById('template_select').value;
    if (idx === "") {
       document.querySelector('select[name="request_type"]').value = "";
       document.getElementById('empty-msg').classList.remove('hidden');
       document.querySelectorAll('.d-field').forEach(d => d.classList.add('hidden'));
       document.querySelector('textarea[name="reason_full"]').value = "";
       document.querySelector('input[name="custom_filename"]').value = "";
       return;
    }
    const t = globalTemplates[idx];
    if (!t) return;
    const reqSelect = document.querySelector('select[name="request_type"]');
    reqSelect.value = t.topic; 
    toggleFields(t.topic);
    document.querySelector('textarea[name="reason_full"]').value = t.reason;
    document.querySelector('input[name="custom_filename"]').value = t.name + "_" + currentUser.name;
    let targetInputName = "";
    switch (t.topic) {
      case 't1': targetInputName = "major_sel"; break;     
      case 't2': targetInputName = "major_to"; break;      
      case 't3': targetInputName = "r_no"; break;          
      case 't5': targetInputName = "reg_reasson"; break;   
      case 't6': targetInputName = "re_ad"; break;         
      case 't7': case 't8': targetInputName = "location"; break;      
      case 't9': targetInputName = "items"; break;         
      case 't10': targetInputName = "other"; break;        
    }
    if (targetInputName) {
      const input = document.querySelector(`[name="${targetInputName}"]`);
      if (input) { input.value = t.data; input.dispatchEvent(new Event('input')); }
    }
    document.querySelectorAll('[data-limit]').forEach(el => el.dispatchEvent(new Event('input')));
  }

  function initData() {
    google.script.run.withSuccessHandler(d => {
      const tOpts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>' + d.teachers.map(t=>`<option value="${t}">${t}</option>`).join('');
      document.querySelectorAll('#advisor_dropdown, .teacher-list').forEach(el => el.innerHTML = tOpts);
      const mOpts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>' + d.majors.map(m=>`<option value="${m}">${m}</option>`).join('');
      document.getElementById('major_main_dropdown').innerHTML = mOpts;
      document.querySelectorAll('.major-list').forEach(el => el.innerHTML = mOpts);
      globalTemplates = d.templates || [];
      const tempOpts = '<option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Template (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) --</option>' + 
                       globalTemplates.map((t, index) => `<option value="${index}">${t.name}</option>`).join('');
      document.getElementById('template_select').innerHTML = tempOpts;
    }).getTemplateData();
  }

  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  function startDraw(e) { drawing = true; ctx.beginPath(); draw(e); }
  function endDraw() { drawing = false; ctx.beginPath(); saveSig(); }
  function draw(e) {
    if (!drawing) return; e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
    ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
  }
  canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchmove', draw);
  function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); document.getElementById('signature_data').value = ""; }
  function saveSig() { document.getElementById('signature_data').value = canvas.toDataURL('image/png'); }

  // --- üî• NEW: CANVAS METRICS MEASUREMENT üî• ---
  // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "Way to be most correct" ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á
  function getVisualPixelWidth(text) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    ctx.font = "12px Sarabun"; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏ô PDF (Scale ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏π‡∏ô‡∏ï‡∏≤‡∏° DPI)
    // 12px ‡πÉ‡∏ô Canvas ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 1 unit ‡πÉ‡∏ô PDF ‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡πÅ‡∏ï‡πà Ratio ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    return ctx.measureText(text).width;
  }
  
  function initInputConstraints() {
    document.querySelectorAll('[data-limit]').forEach(input => {
      const parent = input.parentNode;
      const existing = parent.querySelector('.char-count');
      if(existing) existing.remove();
      const existingBar = parent.querySelector('.energy-bar-container');
      if(existingBar) existingBar.remove();
      const existingLabel = parent.querySelector('.pixel-count-text');
      if(existingLabel) existingLabel.remove();

      let limitPixels = 0;
      let isPixelMode = false;

      if (input.hasAttribute('data-px')) {
         limitPixels = parseInt(input.getAttribute('data-px'));
         isPixelMode = true;
      } else {
         // Fallback for fields without pixel limit in CSV
         limitPixels = parseInt(input.getAttribute('data-limit')) * 7.5; // ‡πÉ‡∏ä‡πâ 7.5 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
      }
      
      const container = document.createElement('div');
      
      const barContainer = document.createElement('div');
      barContainer.className = 'energy-bar-container';
      
      const barFill = document.createElement('div');
      barFill.className = 'energy-bar-fill';
      barContainer.appendChild(barFill);
      
      const textLabel = document.createElement('div');
      textLabel.className = 'pixel-count-text';
      textLabel.innerText = '0%';

      container.appendChild(barContainer);
      container.appendChild(textLabel);
      input.insertAdjacentElement('afterend', container);

      const update = () => {
         let val = input.value;
         if (input.getAttribute('data-type') === 'number') {
            val = val.replace(/\D/g, '');
            input.value = val;
         }
         
         // üî¥ BLOCKING LOGIC: ‡πÉ‡∏ä‡πâ Canvas ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á
         while (getVisualPixelWidth(val) > limitPixels && val.length > 0) {
            val = val.slice(0, -1);
            input.value = val;
         }

         const currentPixels = getVisualPixelWidth(val);
         let percent = (currentPixels / limitPixels) * 100;
         
         if (percent > 100) percent = 100;

         barFill.style.width = `${percent}%`;
         barFill.style.backgroundPosition = `${percent}% 0%`;

         textLabel.innerText = `${Math.round(percent)}%`;
         
         if (currentPixels >= limitPixels) {
             textLabel.style.color = '#dc3545';
             barFill.style.backgroundColor = '#dc3545';
             barFill.style.backgroundImage = 'none';
         } else {
             textLabel.style.color = '#6c757d';
             barFill.style.backgroundImage = 'linear-gradient(90deg, #28a745, #ffc107, #dc3545)';
         }
      };

      input.addEventListener('input', update);
      if(input.value) update();
    });

    const ys = document.querySelectorAll('.year-list');
    let opts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>';
    for(let y=2560; y<=2570; y++) opts += `<option value="${y}">${y}</option>`;
    ys.forEach(s => s.innerHTML = opts);
  }
</script>
</body>
</html>
