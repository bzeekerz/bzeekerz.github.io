<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JC Request Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background: #f0f2f5; font-family: 'Sarabun', sans-serif; }
    .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 12px; }
    .hidden { display: none !important; }
    .no-resize { resize: none !important; }
    .char-count { font-size: 0.8rem; color: #6c757d; display: block; text-align: right; margin-top: 2px; }
    .char-count.limit-reached { color: #dc3545; font-weight: bold; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    #sig-canvas { background: #fff; cursor: crosshair; touch-action: none; }
    .history-item { position: relative; }
    .status-wait { background-color: #ffc107; color: #000; }
    .status-received { background-color: #17a2b8; color: #fff; }
    .status-done { background-color: #28a745; color: #fff; }
    
    /* Admin Table Styles */
    .admin-panel { border-left: 5px solid #0d6efd; background: #fff; }
    .sortable { cursor: pointer; user-select: none; position: relative; }
    .sortable:hover { background-color: #e9ecef !important; }
    .sort-icon { font-size: 0.8rem; margin-left: 5px; color: #999; }
    .sort-asc .sort-icon::after { content: "‚ñ≤"; color: #000; }
    .sort-desc .sort-icon::after { content: "‚ñº"; color: #000; }
  </style>
</head>
<body>

<div id="loading" class="loading-overlay hidden">
  <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
</div>

<input type="file" id="file-input" class="hidden" accept="application/pdf,image/*">

<div class="container py-5">
  <div id="server-alert" class="alert hidden text-center" role="alert"></div>

  <div id="login-page" class="row justify-content-center">
    <div class="col-md-5">
      <div class="card p-4">
        <h3 class="text-center mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <form id="loginForm">
          <div class="mb-3"><input type="text" class="form-control" id="u_name" placeholder="Username" required></div>
          <div class="mb-3"><input type="password" class="form-control" id="u_pass" placeholder="Password" required></div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div class="d-flex justify-content-between mt-3">
          <a href="#" class="small text-decoration-none" onclick="showPage('forgot-page')">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
          <a href="#" class="small text-decoration-none" onclick="showPage('register-page')">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
        </div>
      </div>
    </div>
  </div>

  <div id="register-page" class="hidden row justify-content-center">
     <div class="col-md-6 card p-4">
        <h4>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h4>
        <div class="alert alert-info small"><i class="bi bi-info-circle"></i> ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</div>
        <form id="regForm">
           <div class="row g-2">
             <div class="col-6 mb-2"><input type="text" name="reg_username" class="form-control" placeholder="Username" required></div>
             <div class="col-6 mb-2"><input type="password" name="reg_password" class="form-control" placeholder="Password" required></div>
           </div>
           <input type="text" name="reg_name" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)" required>
           
           <div class="mb-2">
             <label class="form-label me-2">‡πÄ‡∏û‡∏®:</label>
             <div class="form-check form-check-inline">
               <input class="form-check-input" type="radio" name="reg_gender" value="male" required> <label>‡∏ä‡∏≤‡∏¢</label>
             </div>
             <div class="form-check form-check-inline">
               <input class="form-check-input" type="radio" name="reg_gender" value="female" required> <label>‡∏´‡∏ç‡∏¥‡∏á</label>
             </div>
           </div>

           <div class="row g-2 mb-2">
             <div class="col-8"><input type="tel" name="reg_std_id" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" required></div>
             <div class="col-4"><input type="tel" name="reg_year" class="form-control" placeholder="‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ" required></div>
           </div>
           <input type="tel" name="reg_tel" class="form-control mb-2" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required>
           <input type="email" name="reg_email" class="form-control mb-2" placeholder="Email" required>
           
           <button class="btn btn-success w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
           <div class="text-center mt-2"><a href="#" onclick="showPage('login-page')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Login</a></div>
        </form>
     </div>
  </div>

  <div id="forgot-page" class="row justify-content-center hidden">
    <div class="col-md-5 card p-4">
      <h4 class="text-center">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
      <form id="forgotForm">
        <div class="mb-3"><input type="email" id="forgot_email" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required></div>
        <button type="submit" class="btn btn-warning w-100">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <div class="text-center mt-3"><a href="#" onclick="showPage('login-page')">‡∏Å‡∏•‡∏±‡∏ö</a></div>
      </form>
    </div>
  </div>

  <div id="reset-page" class="row justify-content-center hidden">
    <div class="col-md-5 card p-4">
      <h4 class="text-center">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
      <form id="resetForm">
        <input type="hidden" id="reset_token">
        <div class="mb-3"><input type="password" id="new_reset_pass" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" required></div>
        <div class="mb-3"><input type="password" id="confirm_reset_pass" class="form-control" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" required></div>
        <button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </form>
    </div>
  </div>

  <div id="app-page" class="hidden">
    <nav class="navbar navbar-light bg-white rounded shadow-sm px-4 mb-4 d-flex justify-content-between align-items-center">
      <div>
        <span class="navbar-brand h1 m-0">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="disp_name"></span></span>
        <span id="disp_gender" class="badge bg-secondary ms-1 small"></span>
        <span id="disp_role" class="badge bg-dark ms-1 small"></span>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm me-2" onclick="showChangePassModal()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
      </div>
    </nav>

    <div id="admin-section" class="card p-4 mb-4 admin-panel hidden">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="bi bi-shield-lock"></i> Admin Console</h4>
        <div>
           <span class="badge bg-primary rounded-pill" id="admin-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="admin-search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username, ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..." onkeyup="filterAdminTable()">
          </div>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-warning btn-sm" onclick="promptBanUser()"><i class="bi bi-person-x"></i> Ban User</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover table-sm small align-middle">
          <thead class="table-light">
            <tr>
              <th class="sortable" onclick="sortAdminTable('timestamp')">Date <span id="sort-timestamp" class="sort-icon"></span></th>
              <th class="sortable" onclick="sortAdminTable('username')">User <span id="sort-username" class="sort-icon"></span></th>
              <th class="sortable" onclick="sortAdminTable('topic')">Topic <span id="sort-topic" class="sort-icon"></span></th>
              <th>File</th>
              <th class="sortable" onclick="sortAdminTable('status')">Status <span id="sort-status" class="sort-icon"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admin-table-body">
            </tbody>
        </table>
      </div>
    </div>

    <div id="change-pass-modal" class="card p-3 mb-4 border-warning hidden">
      <h5>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h5>
      <form id="changePassForm">
        <div class="row g-2">
          <div class="col-md-4"><input type="password" name="old_pass" class="form-control form-control-sm" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°" required></div>
          <div class="col-md-4"><input type="password" name="new_pass" class="form-control form-control-sm" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" required></div>
          <div class="col-md-4"><button type="submit" class="btn btn-warning btn-sm w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
      </form>
      <div class="text-end mt-2"><a href="#" class="small text-muted" onclick="document.getElementById('change-pass-modal').classList.add('hidden')">‡∏õ‡∏¥‡∏î</a></div>
    </div>

    <div class="row">
      <div class="col-md-7">
        <div class="alert alert-secondary mb-3">
          <label class="fw-bold small mb-1"><i class="bi bi-magic"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Template)</label>
          <select id="template_select" class="form-select" onchange="applyTemplate()">
            <option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Template --</option>
          </select>
        </div>

        <div class="card p-4 mb-4">
          <h4 class="mb-3">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h4>
          <form id="mainForm">
            <div class="mb-3">
              <label class="fw-bold text-primary">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå PDF (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ)</label>
              <input type="text" name="custom_filename" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏™‡∏≠‡∏ö_‡∏ô‡∏≤‡∏¢ ‡∏Å.">
            </div>
            <hr>

            <div class="row g-2 mb-3">
               <div class="col-md-12">
                 <label>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
                 <select name="program" class="form-select">
                   <option value="Thai">‡∏†‡∏≤‡∏Ñ‡∏õ‡∏Å‡∏ï‡∏¥ (Thai)</option>
                   <option value="BJM">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© (BJM)</option>
                 </select>
               </div>
            </div>
            
            <div class="row g-2 mb-3">
              <div class="col-md-4"><label>‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà</label><input type="tel" name="year" id="main_year" class="form-control" data-limit="1" data-type="number" required></div>
              <div class="col-md-8"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" name="tel" id="main_tel" class="form-control" data-limit="10" data-type="number" required></div>
            </div>
            
            <div class="mb-3"><label>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><select name="major" id="major_main_dropdown" class="form-select" required></select></div>
            <div class="mb-3"><label>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label><select name="advisor" id="advisor_dropdown" class="form-select"></select></div>
            <div class="mb-3"><label>Email</label><input type="email" name="email" id="main_email" class="form-control" data-limit="60"></div>
            <div class="mb-3"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><textarea name="address" class="form-control no-resize" rows="2" data-limit="95"></textarea></div>
            <hr>
            
            <div class="mb-3"><label class="fw-bold">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</label>
              <select name="request_type" class="form-select" onchange="toggleFields(this.value)" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>
                <option value="t1">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</option>
                <option value="t2">2. ‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</option>
                <option value="t3">3. ‡∏Ç‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥</option>
                <option value="t4">4. ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞</option>
                <option value="t5">5. ‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
                <option value="t6">6. ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                <option value="t7">7. ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                <option value="t8">8. ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á</option>
                <option value="t9">9. ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>
                <option value="t10">10. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
            
            <div id="dynamic-fields" class="bg-light p-3 rounded mb-3 border">
              <p class="text-muted text-center m-0" id="empty-msg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
              
              <div class="d-field hidden" data-topic="t1">
                <label>‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select name="major_sel" class="form-select major-list"></select>
              </div>
              <div class="d-field hidden" data-topic="t2">
                <label>‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å</label><select name="major_from" class="form-select major-list mb-2"></select>
                <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏≠‡∏Å</label><select name="major_to" class="form-select major-list"></select>
              </div>
              <div class="d-field hidden" data-topic="t3">
                <label>‡πÄ‡∏™‡∏ô‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</label><select name="prof_rec" class="form-select teacher-list mb-2"></select>
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label><input type="tel" name="r_no" class="form-control" data-limit="1" data-type="number">
              </div>
              <div class="d-field hidden" data-topic="t5">
                <div class="row g-2">
                   <div class="col-4"><label>‡πÄ‡∏ó‡∏≠‡∏°</label><input name="reg_sem" class="form-control" data-limit="1" data-type="number"></div>
                   <div class="col-4"><label>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label><select name="reg_year" class="form-select year-list"></select></div>
                   <div class="col-12"><label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label><input name="reg_reasson" class="form-control" data-limit="30"></div>
                </div>
              </div>
              <div class="d-field hidden" data-topic="t6">
                 <div class="row g-2">
                   <div class="col-6"><label>‡πÄ‡∏ó‡∏≠‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û</label><input name="re_ad" class="form-control" data-limit="1" data-type="number"></div>
                   <div class="col-6"><label>‡∏õ‡∏µ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û</label><select name="re_ad_year" class="form-select year-list"></select></div>
                 </div>
              </div>
              <div class="d-field hidden" data-topic="t7 t8">
                 <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ</label><input name="location" class="form-control no-resize" data-limit="90">
              </div>
              <div class="d-field hidden" data-topic="t9">
                 <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label><input name="items" class="form-control no-resize" data-limit="90">
              </div>
              <div class="d-field hidden" data-topic="t10">
                 <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏</label><input name="other" class="form-control no-resize" data-limit="90">
              </div>
            </div>
            
            <div class="mb-3">
              <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label>
              <textarea name="reason_full" class="form-control no-resize" rows="4" data-limit="280"></textarea>
            </div>

            <div class="mb-3 text-center">
              <label class="fw-bold">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</label><br>
              <canvas id="sig-canvas" width="300" height="120" class="border rounded"></canvas><br>
              <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="clearSig()">‡∏•‡πâ‡∏≤‡∏á</button>
              <input type="hidden" name="signature_data" id="signature_data">
            </div>

            <button type="submit" class="btn btn-primary w-100">‡∏™‡∏£‡πâ‡∏≤‡∏á PDF</button>
          </form>
        </div>
      </div>
      
      <div class="col-md-5">
        <div class="card p-3">
          <h5>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h5>
          <div id="history-list" class="list-group list-group-flush small">Loading...</div>
          <button class="btn btn-sm btn-secondary mt-3" onclick="loadRequests()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentUser = null;
  let globalTemplates = [];
  let currentUploadFileId = null;
  let adminDataList = [];
  let currentSort = { col: 'timestamp', order: 'desc' };

  // --- üî¥ SESSION MANAGEMENT (‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ) ---
  const SESSION_KEY = 'JC_FORM_SESSION';
  const SESSION_DURATION = 5 * 60 * 1000; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ

  function saveSession(userData) {
    const sessionData = {
      user: userData,
      expiry: new Date().getTime() + SESSION_DURATION
    };
    localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
  }

  function checkSession() {
    const sessionString = localStorage.getItem(SESSION_KEY);
    if (!sessionString) return null;
    const session = JSON.parse(sessionString);
    if (new Date().getTime() > session.expiry) {
      localStorage.removeItem(SESSION_KEY);
      return null;
    }
    return session.user;
  }
  // ----------------------------------------------------

  const TOPIC_MAP = {
      't1': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤',
      't2': '‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤',
      't3': '‡∏Ç‡∏≠‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥',
      't4': '‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞',
      't5': '‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å',
      't6': '‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
      't7': '‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',
      't8': '‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á',
      't9': '‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
      't10': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
  };
  
  const urlParams = <?!= urlParams ?> || {};
  const serverMsg = "<?= serverMessage ?>";
  const serverStatus = "<?= serverStatus ?>";

  window.onload = function() {
    if (serverMsg && serverMsg !== 'undefined') {
      const alertBox = document.getElementById('server-alert');
      alertBox.className = `alert alert-${serverStatus === 'success' ? 'success' : 'danger'}`;
      alertBox.innerText = serverMsg;
      alertBox.classList.remove('hidden');
    }

    if (urlParams.page === 'reset' && urlParams.token) {
      document.getElementById('reset_token').value = urlParams.token;
      showPage('reset-page');
    } else {
        // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SESSION ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ---
        const savedUser = checkSession();
        if (savedUser) {
            setupAppUI(savedUser); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Session ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÄ‡∏•‡∏¢
        } else {
            showPage('login-page');
        }
    }
    initInputConstraints();
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  function setupAppUI(user) {
    currentUser = user;
    document.getElementById('disp_name').innerText = user.name;
    document.getElementById('disp_gender').innerText = user.gender === 'male' ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á';
    
    if(user.role === 'admin') {
       document.getElementById('admin-section').classList.remove('hidden');
       document.getElementById('disp_role').innerText = 'Admin';
    } else {
       document.getElementById('admin-section').classList.add('hidden');
    }

    document.getElementById('main_year').value = user.year || '';
    document.getElementById('main_tel').value = user.tel || '';
    document.getElementById('main_email').value = user.email || '';
    
    showPage('app-page');
    initData();
    loadRequests();
  }

  function showPage(pid) {
    document.querySelectorAll('.container > div[id$="-page"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(pid).classList.remove('hidden');
    if(pid === 'app-page' || pid === 'register-page') setTimeout(initInputConstraints, 100);
  }
  function showChangePassModal() { document.getElementById('change-pass-modal').classList.remove('hidden'); }
  function toggleLoad(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
  
  function logout() { 
      localStorage.removeItem(SESSION_KEY); // ‡∏•‡∏ö Session
      location.reload(); 
  }

  // --- LOGIN & REGISTER LOGIC ---
  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault(); toggleLoad(true);
    google.script.run.withSuccessHandler(res => {
      toggleLoad(false);
      if(res.status === 'success') {
        saveSession(res); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡∏ú‡πà‡∏≤‡∏ô
        setupAppUI(res);
      } else alert(res.message);
    }).loginUser(document.getElementById('u_name').value, document.getElementById('u_pass').value);
  });

  document.getElementById('regForm').addEventListener('submit', function(e) {
    e.preventDefault(); toggleLoad(true);
    const data = {}; new FormData(this).forEach((v,k)=>data[k]=v);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') showPage('login-page'); }).registerUser(data);
  });

  document.getElementById('forgotForm').addEventListener('submit', e => {
    e.preventDefault(); toggleLoad(true);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') showPage('login-page'); }).requestPasswordReset(document.getElementById('forgot_email').value);
  });

  document.getElementById('resetForm').addEventListener('submit', e => {
    e.preventDefault(); 
    if(document.getElementById('new_reset_pass').value !== document.getElementById('confirm_reset_pass').value) return alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
    toggleLoad(true);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success') window.location.href="<?= getScriptUrl() ?>"; }).submitResetPassword(document.getElementById('reset_token').value, document.getElementById('new_reset_pass').value);
  });

  document.getElementById('changePassForm').addEventListener('submit', function(e) {
    e.preventDefault(); toggleLoad(true);
    const data = new FormData(this);
    google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res.message); if(res.status==='success'){ this.reset(); document.getElementById('change-pass-modal').classList.add('hidden'); } }).changePassword(currentUser.username, data.get('old_pass'), data.get('new_pass'));
  });

  document.getElementById('mainForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if(!currentUser) return;
    saveSig(); toggleLoad(true);
    const data = {}; new FormData(this).forEach((v,k)=>data[k]=v);
    google.script.run.withSuccessHandler(res => {
      toggleLoad(false);
      if(res.status === 'success') {
        if(confirm('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°?')) window.open(res.url);
        loadRequests(); clearSig(); this.reset();
        document.getElementById('main_year').value = currentUser.year || '';
        document.getElementById('main_tel').value = currentUser.tel || '';
        document.getElementById('main_email').value = currentUser.email || '';
        document.querySelectorAll('.char-count').forEach(el => el.innerText = `0 / ${el.innerText.split(' / ')[1]}`);
      } else alert(res.message);
    }).withFailureHandler(e => { toggleLoad(false); alert(e); }).processForm(data, currentUser);
  });

  // --- DASHBOARD & ADMIN LOGIC ---
  function loadRequests() {
    if(!currentUser) return;
    google.script.run.withSuccessHandler(data => {
      renderHistory(data);
      if(currentUser.role === 'admin') {
          adminDataList = data;
          renderAdminTable(adminDataList);
      }
    }).getRequestsData(currentUser);
  }

  function renderHistory(list) {
    const el = document.getElementById('history-list');
    if(!list.length) { el.innerHTML = '<div class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'; return; }
    
    el.innerHTML = list.map(i => {
      let badge = `<span class="badge status-wait">‡∏£‡∏≠</span>`;
      if(i.status === '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß') badge = `<span class="badge status-received">‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
      if(i.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') badge = `<span class="badge status-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>`;

      let adminFileLink = i.adminFile ? `<div class="mt-2"><a href="${i.adminFile}" target="_blank" class="btn btn-success btn-sm w-100"><i class="bi bi-check-circle"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</a></div>` : '';

      return `
        <div class="list-group-item py-2 history-item">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex:1;">
               <strong class="d-block text-primary text-truncate" style="max-width:180px;">${i.fileName}</strong>
               <small class="text-muted">${i.timestamp} | ${i.type}</small>
            </div>
            ${badge}
          </div>
          <div class="mt-1">
             <a href="${i.pdfUrl}" target="_blank" class="small text-decoration-none"><i class="bi bi-file-earmark-pdf"></i> ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a>
             ${i.studentFile ? ` | <a href="${i.studentFile}" target="_blank" class="small text-decoration-none text-info"><i class="bi bi-file-earmark-arrow-up"></i> ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</a>` : ''}
          </div>
          ${adminFileLink}
          <div class="mt-2 pt-2 border-top">
             <button class="btn btn-outline-primary btn-sm w-100" style="font-size: 0.8rem;" onclick="triggerUpload('${i.fileId}')">
               <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà / ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
             </button>
             <div class="mt-1 d-flex justify-content-end">
               <span class="badge bg-warning text-dark action-btn" onclick="renameItem('${i.fileId}')" style="cursor:pointer; margin-right:5px;">‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠</span>
               <span class="badge bg-danger action-btn" onclick="deleteItem('${i.fileId}')" style="cursor:pointer;">‡∏•‡∏ö</span>
             </div>
          </div>
        </div>`;
    }).join('');
  }

  function renderAdminTable(list) {
    const tbody = document.getElementById('admin-table-body');
    document.getElementById('admin-count').innerText = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    if(list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
    }

    tbody.innerHTML = list.map(i => {
        const topicName = TOPIC_MAP[i.type] || i.type || '-';
        let statusClass = 'bg-secondary';
        if(i.status === '‡∏£‡∏≠') statusClass = 'bg-warning text-dark';
        else if(i.status === '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß') statusClass = 'bg-info text-white';
        else if(i.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') statusClass = 'bg-success text-white';

        return `
      <tr>
        <td class="text-nowrap">${i.timestamp}</td>
        <td>${i.username}</td>
        <td><span class="badge bg-light text-dark border">${topicName}</span></td>
        <td>
            <a href="${i.pdfUrl}" target="_blank" class="text-decoration-none">
                <i class="bi bi-file-pdf text-danger"></i> ${i.fileName.substring(0, 15)}...
            </a>
        </td>
        <td>
          <select class="form-select form-select-sm badge ${statusClass}" 
                  style="width:auto; cursor:pointer;" 
                  onchange="changeStatus('${i.fileId}', this.value); this.className='form-select form-select-sm badge '+ (this.value==='‡∏£‡∏≠'?'bg-warning text-dark':(this.value==='‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'?'bg-info text-white':'bg-success text-white'))">
            <option value="‡∏£‡∏≠" class="bg-white text-dark" ${i.status==='‡∏£‡∏≠'?'selected':''}>‡∏£‡∏≠</option>
            <option value="‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß" class="bg-white text-dark" ${i.status==='‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" class="bg-white text-dark" ${i.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
        </td>
        <td>
          <div class="btn-group" role="group">
             <button class="btn btn-outline-secondary btn-sm" onclick="triggerUpload('${i.fileId}')" title="Upload Result"><i class="bi bi-upload"></i></button>
             ${i.studentFile ? `<a href="${i.studentFile}" target="_blank" class="btn btn-outline-primary btn-sm" title="View User File"><i class="bi bi-eye"></i></a>` : ''}
          </div>
        </td>
      </tr>
    `;
    }).join('');
    updateSortIcons();
  }

  function sortAdminTable(col) {
    if (currentSort.col === col) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.col = col;
        currentSort.order = 'asc';
    }

    const sortedList = [...adminDataList].sort((a, b) => {
        let valA, valB;
        if (col === 'timestamp') {
            valA = parseCustomDate(a.timestamp);
            valB = parseCustomDate(b.timestamp);
        } else if (col === 'topic') {
            valA = TOPIC_MAP[a.type] || a.type || '';
            valB = TOPIC_MAP[b.type] || b.type || '';
        } else {
            valA = String(a[col] || '').toLowerCase();
            valB = String(b[col] || '').toLowerCase();
        }

        if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
        return 0;
    });
    
    filterAdminTable(sortedList);
  }

  function filterAdminTable(sourceList = null) {
    let list = sourceList;
    if (!sourceList) {
         sortAdminTable(currentSort.col); 
         return; 
    }

    const term = document.getElementById('admin-search').value.toLowerCase().trim();
    const filtered = list.filter(item => {
        const topic = (TOPIC_MAP[item.type] || '').toLowerCase();
        const user = (item.username || '').toLowerCase();
        const status = (item.status || '').toLowerCase();
        const date = (item.timestamp || '').toLowerCase();
        
        return user.includes(term) || topic.includes(term) || status.includes(term) || date.includes(term);
    });

    renderAdminTable(filtered);
  }

  function parseCustomDate(dateStr) {
    if(!dateStr || dateStr === '-') return 0;
    const [dRange, tRange] = dateStr.split(' ');
    if(!dRange) return 0;
    const [d, m, y] = dRange.split('/');
    const [hr, min] = tRange ? tRange.split(':') : [0,0];
    return new Date(y, m-1, d, hr, min).getTime();
  }

  function updateSortIcons() {
    document.querySelectorAll('.sort-icon').forEach(el => el.parentElement.className = 'sortable');
    const activeHeader = document.querySelector(`th[onclick="sortAdminTable('${currentSort.col}')"]`);
    if(activeHeader) {
        activeHeader.className = `sortable sort-${currentSort.order}`;
    }
  }

  // --- UPLOAD, UTILS & INIT ---
  function triggerUpload(fileId) {
    currentUploadFileId = fileId;
    document.getElementById('file-input').click();
  }

  document.getElementById('file-input').addEventListener('change', function() {
    if (this.files.length === 0) return;
    const file = this.files[0];
    const reader = new FileReader();
    toggleLoad(true);
    reader.onload = function(e) {
      google.script.run.withSuccessHandler(res => {
        toggleLoad(false);
        alert(res.message);
        loadRequests(); 
      }).uploadFile(e.target.result, file.type, currentUploadFileId, currentUser.role, currentUser.username);
    };
    reader.readAsDataURL(file);
  });

  function changeStatus(fileId, newStatus) {
    google.script.run.withSuccessHandler(msg => console.log(msg)).adminUpdateStatus(fileId, newStatus);
  }

  function promptBanUser() {
    const email = prompt("‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:");
    if(email) {
      toggleLoad(true);
      google.script.run.withSuccessHandler(res => { toggleLoad(false); alert(res); }).adminBanUser(email);
    }
  }

  function renameItem(fileId) {
     const newName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:");
     if(newName) {
       toggleLoad(true);
       google.script.run.withSuccessHandler(res => {
         toggleLoad(false);
         alert(res.message);
         if(res.status==='success') loadRequests();
       }).renameHistory(fileId, newName, currentUser.username);
     }
  }

  function deleteItem(fileId) {
     if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
       toggleLoad(true);
       google.script.run.withSuccessHandler(res => {
         toggleLoad(false);
         alert(res.message);
         if(res.status==='success') loadRequests();
       }).deleteHistory(fileId, currentUser.username);
     }
  }

  function toggleFields(topic) {
    if (!topic) return;
    document.getElementById('empty-msg').classList.add('hidden');
    document.querySelectorAll('.d-field').forEach(div => {
       const topics = div.getAttribute('data-topic').split(' ');
       if (topics.includes(topic)) div.classList.remove('hidden');
       else div.classList.add('hidden');
    });
  }

  function applyTemplate() {
    const idx = document.getElementById('template_select').value;
    if (idx === "") {
       document.querySelector('select[name="request_type"]').value = "";
       document.getElementById('empty-msg').classList.remove('hidden');
       document.querySelectorAll('.d-field').forEach(d => d.classList.add('hidden'));
       document.querySelector('textarea[name="reason_full"]').value = "";
       document.querySelector('input[name="custom_filename"]').value = "";
       return;
    }
    
    const t = globalTemplates[idx];
    if (!t) return;

    const reqSelect = document.querySelector('select[name="request_type"]');
    reqSelect.value = t.topic; 
    toggleFields(t.topic);
    document.querySelector('textarea[name="reason_full"]').value = t.reason;
    document.querySelector('input[name="custom_filename"]').value = t.name + "_" + currentUser.name;

    let targetInputName = "";
    switch (t.topic) {
      case 't1': targetInputName = "major_sel"; break;     
      case 't2': targetInputName = "major_to"; break;      
      case 't3': targetInputName = "r_no"; break;          
      case 't5': targetInputName = "reg_reasson"; break;   
      case 't6': targetInputName = "re_ad"; break;         
      case 't7': case 't8': targetInputName = "location"; break;      
      case 't9': targetInputName = "items"; break;         
      case 't10': targetInputName = "other"; break;        
    }

    if (targetInputName) {
      const input = document.querySelector(`[name="${targetInputName}"]`);
      if (input) { input.value = t.data; input.dispatchEvent(new Event('input')); }
    }
    document.querySelectorAll('[data-limit]').forEach(el => el.dispatchEvent(new Event('input')));
  }

  function initData() {
    google.script.run.withSuccessHandler(d => {
      const tOpts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>' + d.teachers.map(t=>`<option value="${t}">${t}</option>`).join('');
      document.querySelectorAll('#advisor_dropdown, .teacher-list').forEach(el => el.innerHTML = tOpts);
      
      const mOpts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>' + d.majors.map(m=>`<option value="${m}">${m}</option>`).join('');
      document.getElementById('major_main_dropdown').innerHTML = mOpts;
      document.querySelectorAll('.major-list').forEach(el => el.innerHTML = mOpts);

      globalTemplates = d.templates || [];
      const tempOpts = '<option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Template (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) --</option>' + 
                       globalTemplates.map((t, index) => `<option value="${index}">${t.name}</option>`).join('');
      document.getElementById('template_select').innerHTML = tempOpts;
    }).getTemplateData();
  }

  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  function startDraw(e) { drawing = true; ctx.beginPath(); draw(e); }
  function endDraw() { drawing = false; ctx.beginPath(); saveSig(); }
  function draw(e) {
    if (!drawing) return; e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
    ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
  }
  canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchmove', draw);
  function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); document.getElementById('signature_data').value = ""; }
  function saveSig() { document.getElementById('signature_data').value = canvas.toDataURL('image/png'); }

  function getVisualLen(t) { return t.replace(/[\u0E31\u0E34-\u0E3A\u0E47-\u0E4E]/g, '').length; }
  
  function initInputConstraints() {
    document.querySelectorAll('[data-limit]').forEach(input => {
      const parent = input.parentNode;
      const existing = parent.querySelector('.char-count');
      if(existing) existing.remove();

      const limit = parseInt(input.getAttribute('data-limit'));
      const counterEl = document.createElement('div');
      counterEl.className = 'char-count';
      counterEl.innerText = `0 / ${limit}`;
      
      input.insertAdjacentElement('afterend', counterEl);

      const update = () => {
         let val = input.value;
         if (input.getAttribute('data-type') === 'number') val = val.replace(/\D/g, '');
         while (getVisualLen(val) > limit) val = val.slice(0, -1);
         input.value = val;
         const len = getVisualLen(val);
         counterEl.innerText = `${len} / ${limit}`;
         counterEl.classList.toggle('limit-reached', len >= limit);
      };
      input.addEventListener('input', update);
      if(input.value) update();
    });
    
    const ys = document.querySelectorAll('.year-list');
    let opts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>';
    for(let y=2560; y<=2570; y++) opts += `<option value="${y}">${y}</option>`;
    ys.forEach(s => s.innerHTML = opts);
  }
</script>
</body>
</html>
